<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>كشف حساب عميل - نظام إدارة السوبر ماركت</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: var(--radius-md);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-color);
      }
      .stat-card h3 {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
      }
      .stat-card .value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
      }
      .deleted-row {
        background-color: #f9fafb;
        opacity: 0.6;
        text-decoration: line-through;
      }
      .deleted-row td {
        color: #9ca3af;
      }
    </style>
  </head>

  <body>
    <div class="main-container">
      <aside class="sidebar">
        <div class="sidebar-header">
          <img
            src="assets/images/logo.svg"
            alt="Market Logo"
            class="logo-img"
          />
          <h2>السوبر ماركت</h2>
        </div>
        <div class="sidebar-nav"></div>
      </aside>

      <main class="content animate-fade">
        <div class="page-header">
          <div>
            <h1 id="customer-name-header">كشف حساب عميل</h1>
            <p class="text-secondary" id="customer-phone-header"></p>
          </div>
          <div class="header-actions">
            <div
              class="user-info-header"
              style="
                display: flex;
                align-items: center;
                gap: 1rem;
                border-right: 1px solid var(--border-color);
                padding-right: 1rem;
                margin-right: 1rem;
              "
            >
              <span
                id="userNameDisplay"
                style="font-weight: 600; color: var(--text-primary)"
              ></span>
              <span id="userRoleBadge" class="badge"></span>
            </div>
            <button class="btn btn-secondary" onclick="openFilterDialog()">
              تصفية / بحث
            </button>
            <button
              class="btn btn-primary"
              onclick="openAddTransactionDialog()"
              data-icon="plus"
            >
              تسجيل عملية (سند قبض/صرف)
            </button>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <h3>إجمالي المبيعات (مدين)</h3>
            <div class="value" id="stat-debit">0.00</div>
          </div>
          <div class="stat-card">
            <h3>إجمالي المقبوضات (دائن)</h3>
            <div class="value text-success" id="stat-credit">0.00</div>
          </div>
          <div class="stat-card">
            <h3>الرصيد الحالي</h3>
            <div class="value" id="stat-balance">0.00</div>
          </div>
          <div class="stat-card">
            <h3>عدد العمليات</h3>
            <div class="value" id="stat-count">0</div>
          </div>
        </div>

        <div id="alert-container"></div>

        <div class="table-container">
          <div
            style="padding: 1rem; display: flex; gap: 1rem; align-items: center"
          >
            <label
              style="
                display: flex;
                align-items: center;
                gap: 0.5rem;
                cursor: pointer;
              "
            >
              <input
                type="checkbox"
                id="show-deleted"
                onchange="fetchLedger()"
              />
              عرض المحذوفات
            </label>
          </div>
          <div class="table-wrapper">
            <table id="ledger-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>التاريخ</th>
                  <th>نوع العملية</th>
                  <th>الوصف</th>
                  <th>مدين (عليك)</th>
                  <th>دائن (لك)</th>
                  <th>المستخدم</th>
                  <th>الإجراءات</th>
                </tr>
              </thead>
              <tbody id="ledger-tbody">
                <tr>
                  <td colspan="8" class="text-center">جاري التحميل...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="pagination-container" id="pagination-controls"></div>
        </div>
      </main>
    </div>

    <!-- Filter Dialog -->
    <div class="dialog-overlay" id="filter-dialog">
      <div class="dialog">
        <div class="dialog-header">
          <h2>تصفية العمليات</h2>
          <button class="close-btn" onclick="closeDialog('filter-dialog')">
            &times;
          </button>
        </div>
        <div class="dialog-body">
          <form id="filter-form">
            <div class="form-row">
              <div class="form-group">
                <label>من تاريخ</label>
                <input type="date" id="filter-from" />
              </div>
              <div class="form-group">
                <label>إلى تاريخ</label>
                <input type="date" id="filter-to" />
              </div>
            </div>
            <div class="form-group">
              <label>نوع العملية</label>
              <select id="filter-type">
                <option value="">الكل</option>
                <option value="invoice">فاتورة مبيعات</option>
                <option value="payment">سند قبض (دفعة)</option>
                <option value="return">مرتجع</option>
              </select>
            </div>
          </form>
        </div>
        <div class="dialog-footer">
          <button class="btn btn-primary" onclick="applyFilter()">تطبيق</button>
          <button class="btn" onclick="closeDialog('filter-dialog')">
            إغلاق
          </button>
        </div>
      </div>
    </div>

    <!-- Add/Edit Transaction Dialog -->
    <div class="dialog-overlay" id="transaction-dialog">
      <div class="dialog">
        <div class="dialog-header">
          <h2 id="trans-dialog-title">تسجيل عملية</h2>
          <button class="close-btn" onclick="closeDialog('transaction-dialog')">
            &times;
          </button>
        </div>
        <div class="dialog-body">
          <form id="trans-form">
            <input type="hidden" id="trans-id" />
            <div class="form-group">
              <label>نوع العملية *</label>
              <select id="trans-type" required>
                <option value="payment">سند قبض (استلام نقدية)</option>
                <option value="invoice">فاتورة (أجل) - يدوي</option>
              </select>
            </div>
            <div class="form-group">
              <label>المبلغ *</label>
              <input type="number" step="0.01" id="trans-amount" required />
            </div>
            <div class="form-group">
              <label>التاريخ *</label>
              <input type="date" id="trans-date" required />
            </div>
            <div class="form-group full-width">
              <label>الوصف / البيان</label>
              <textarea id="trans-desc" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="dialog-footer">
          <button
            type="button"
            class="btn btn-primary"
            onclick="saveTransaction()"
          >
            حفظ
          </button>
          <button
            type="button"
            class="btn"
            onclick="closeDialog('transaction-dialog')"
          >
            إلغاء
          </button>
        </div>
      </div>
    </div>

    <!-- View Invoice Dialog -->
    <div class="dialog-overlay" id="view-dialog">
      <div class="dialog">
        <div class="dialog-header">
          <h2>تفاصيل الفاتورة</h2>
          <button class="close-btn" onclick="closeDialog('view-dialog')">
            &times;
          </button>
        </div>
        <div class="dialog-body" id="view-dialog-body">
          <!-- Content will be populated by JavaScript -->
        </div>
        <div class="dialog-footer">
          <button
            type="button"
            class="btn"
            onclick="closeDialog('view-dialog')"
          >
            إغلاق
          </button>
        </div>
      </div>
    </div>

    <!-- Confirm Dialog -->
    <div class="dialog-overlay" id="confirm-dialog">
      <div class="dialog" style="max-width: 400px; width: 90%">
        <div
          class="dialog-header"
          style="margin-bottom: 1rem; border-bottom: none"
        >
          <h2
            id="confirm-title"
            style="
              color: var(--danger-color);
              display: flex;
              align-items: center;
              gap: 0.5rem;
            "
          >
            تأكيد الإجراء
          </h2>
          <button class="close-btn" onclick="closeConfirmDialog(false)">
            &times;
          </button>
        </div>
        <div class="dialog-body">
          <p
            id="confirm-message"
            style="
              font-size: 1.1rem;
              color: var(--text-primary);
              margin: 0 0 2rem 0;
              line-height: 1.6;
            "
          >
            هل أنت متأكد؟
          </p>
        </div>
        <div class="dialog-footer" style="margin-top: 1rem; border-top: none">
          <button
            type="button"
            class="btn"
            style="background-color: var(--danger-color); color: white"
            id="confirm-yes-btn"
          >
            نعم، متابعة
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeConfirmDialog(false)"
          >
            إلغاء
          </button>
        </div>
      </div>
    </div>

    <script src="common.js"></script>
    <script src="ar_ledger.js"></script>
  </body>
</html>
